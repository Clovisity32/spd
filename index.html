<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Pathway Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        /* For Lucide icons via CDN (alternative to npm) */
        /* We will use inline SVGs or simple text for icons to avoid external dependencies beyond Tailwind if possible */
        .icon-sm { width: 18px; height: 18px; display: inline-block; vertical-align: middle; }
        .icon-md { width: 20px; height: 20px; display: inline-block; vertical-align: middle; }
        .icon-lg { width: 24px; height: 24px; display: inline-block; vertical-align: middle; }

        /* Custom Message Box */
        #customMessageBox {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        #customMessageBox.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            height: 24px; /* Fixed height for alignment */
        }
        .bar-label {
            width: 150px; /* Adjust as needed */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
            font-size: 0.875rem; /* text-sm */
            color: #cbd5e1; /* slate-300 */
        }
        .bar {
            height: 100%;
            background-image: linear-gradient(to right, #22d3ee, #10b981);
            border-radius: 0.25rem; /* rounded-sm */
            transition: width 0.5s ease-in-out;
            text-align: right;
            padding-right: 5px;
            color: white;
            font-size: 0.75rem; /* text-xs */
            line-height: 24px; /* Match height */
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: max-content;
            max-width: 250px;
            background-color: #0f172a; /* slate-900 */
            color: #e2e8f0; /* slate-200 */
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above the element */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            border: 1px solid #334155; /* slate-700 */
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-sky-900 min-h-screen text-gray-100">

    <div id="customMessageBox" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full border border-slate-700">
            <h3 id="messageBoxTitle" class="text-lg font-semibold text-cyan-400 mb-3">Notification</h3>
            <p id="messageBoxText" class="text-slate-300 mb-6"></p>
            <button id="messageBoxOkButton" class="w-full p-2 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg transition duration-150">
                OK
            </button>
        </div>
    </div>

    <div class="p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 via-cyan-400 to-sky-500">
                Student Pathway Dashboard
            </h1>
            <p class="text-sky-300 mt-2 text-lg">
                Explore your post-secondary options based on your subject grades.
            </p>
        </header>

        <section class="mb-10 p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M21 22L17.592 18.592C19.089 16.839 20 14.745 20 12.5C20 7.258 15.742 3 10.5 3S1 7.258 1 12.5C1 17.742 5.258 22 10.5 22C12.745 22 14.839 21.089 16.592 19.592L20 23L21 22ZM10.5 20C6.364 20 3 16.636 3 12.5C3 8.364 6.364 5 10.5 5C14.636 5 18 8.364 18 12.5C18 16.636 14.636 20 10.5 20Z"></path><path d="M11.5 8H9.5V12H11.5V8Z"></path><path d="M11.5 14H9.5V16H11.5V14Z"></path></svg> Enter Your Subjects & Grades
            </h2>
            
            <div class="grid md:grid-cols-5 gap-4 mb-4 items-end">
                <div>
                    <label for="subject" class="block text-sm font-medium text-sky-300 mb-1">Subject</label>
                    <select id="subject" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        <option value="">Select Subject</option>
                    </select>
                </div>
                <div>
                    <label for="level" class="block text-sm font-medium text-sky-300 mb-1">Level</label>
                    <select id="level" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        </select>
                </div>
                <div>
                    <label for="grade" class="block text-sm font-medium text-sky-300 mb-1">Grade</label>
                    <select id="grade" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100">
                        </select>
                </div>
                <div>
                    <label for="bonus" class="block text-sm font-medium text-sky-300 mb-1">Bonus Points (Max 4)</label>
                    <input type="number" id="bonus" value="0" min="0" max="4" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100" />
                </div>
                <button id="addUpdateSubjectBtn" class="w-full p-3 bg-gradient-to-r from-emerald-500 to-cyan-600 hover:from-emerald-600 hover:to-cyan-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out flex items-center justify-center text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2"><path d="M12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2ZM17 13H13V17H11V13H7V11H11V7H13V11H17V13Z"></path></svg> <span id="addUpdateBtnText">Add Subject</span>
                </button>
            </div>

            <div id="studentSubjectsTableContainer" class="mt-8 hidden">
                <h3 class="text-xl font-semibold mb-3 text-sky-400">Your Subjects:</h3>
                <div class="overflow-x-auto rounded-lg border border-slate-700">
                    <table class="min-w-full divide-y divide-slate-700">
                        <thead class="bg-slate-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Subject</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Level</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-sky-300 uppercase tracking-wider">Grade</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-sky-300 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentSubjectsTableBody" class="bg-slate-800 divide-y divide-slate-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="mb-10 p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M12 2C17.523 2 22 6.477 22 12C22 17.523 17.523 22 12 22C6.477 22 2 17.523 2 12C2 6.477 6.477 2 12 2ZM12 4C7.582 4 4 7.582 4 12C4 16.418 7.582 20 12 20C16.418 20 20 16.418 20 12C20 7.582 16.418 4 12 4ZM12 11C11.448 11 11 11.448 11 12C11 12.552 11.448 13 12 13C12.552 13 13 12.552 13 12C13 11.448 12.552 11 12 11ZM12 6C9.791 6 8 7.791 8 10H10C10 8.896 10.896 8 12 8C13.104 8 14 8.896 14 10C14 12 11 11.75 11 15H13C13 12.75 16 12.5 16 10C16 7.791 14.209 6 12 6Z"></path></svg> Pathway Eligibility
            </h2>
            <div id="eligibilityResultsContainer" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div id="eligibilityPlaceholder" class="text-center py-8 text-slate-400 md:col-span-2 lg:col-span-3">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-sky-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM11 7H13V11H11V7ZM11 13H13V17H11V13Z"></path></svg> <p class="text-xl">Please add subjects to see your eligible pathways.</p>
                </div>
            </div>
        </section>

        <section id="improvementSuggestionsSection" class="p-6 bg-slate-800 shadow-2xl rounded-xl border border-slate-700 hidden">
            <h2 class="text-2xl font-semibold mb-6 text-cyan-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mr-3 text-cyan-500"><path d="M3 17H5V19H3V17ZM7 5H9V19H7V5ZM11 13H13V19H11V13ZM15 9H17V19H15V9ZM19 12H21V19H19V12Z"></path></svg> Improvement Suggestions
            </h2>
            <div id="improvementSuggestionsContainer">
                </div>
            <div id="improvementPlaceholder" class="text-center py-8 text-slate-400">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-lg mx-auto mb-4 text-emerald-500 w-12 h-12"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg> <p class="text-xl">Add subjects to see improvement suggestions or you're doing great!</p>
            </div>
        </section>

        <footer class="text-center mt-12 text-sm text-slate-500">
            <p>&copy; <span id="currentYear"></span> Student Pathway Dashboard. For informational purposes only.</p>
            <p>Always verify eligibility criteria with official sources.</p>
            <p class="mt-1">Based on Full SBB Post-Sec Options w.e.f. 2027 S4/5 Cohort (Affecting: 2025 S1 & S2 Full SBB) document.</p>
        </footer>
    </div>

    <script>
        // --- Constants and Configuration (Copied from React App) ---
        const G3_GRADES_OPTIONS = ["A1", "A2", "B3", "B4", "C5", "C6", "D7", "E8", "F9", "U"];
        const G2_GRADES_OPTIONS = ["1", "2", "3", "4", "5", "6", "U"];
        const G1_GRADES_OPTIONS = ["A", "B", "C", "D", "E", "U"];
        const GRADE_LEVELS = ["G3", "G2", "G1"];

        const G3_TO_NUMERIC_RAW = { A1: 1, A2: 2, B3: 3, B4: 4, C5: 5, C6: 6, D7: 7, E8: 8, F9: 9, U: 10 };
        const G2_TO_NUMERIC_RAW = { "1": 1, "2": 2, "3": 3, "4": 4, "5": 5, "6": 6, U: 7 };
        const G1_TO_NUMERIC_RAW_ITE = { A: 1, B: 2, C: 3, D: 4, E: 5, U: 6 };

        const G3_TO_G2_CONVERSION_MAP = {
            A1: "1", A2: "1", B3: "1", B4: "2", C5: "2", C6: "2", D7: "3", E8: "4", F9: "5", U: "6"
        };
        
        const G3_TO_G1_EQUIV_MAP = {
            A1: "A", A2: "A", B3: "A", B4: "A", C5: "A", C6: "A", D7: "A", E8: "B", F9: "C", "U": "D"
        };

        const G2_TO_G1_EQUIV_MAP = {
            "1": "A", "2": "A", "3": "A", "4": "B", "5": "C", "6": "D",
        };

        const ALL_SUBJECTS_LIST = [
            { id: "EL", name: "English Language", category: "EL" }, { id: "MATH", name: "Mathematics", category: "MATH" },
            { id: "AM", name: "Additional Mathematics", category: "MATH_RELATED" }, { id: "HMT_CH", name: "Higher Chinese", category: "HMT" },
            { id: "HMT_MA", name: "Higher Malay", category: "HMT" }, { id: "HMT_TA", name: "Higher Tamil", category: "HMT" },
            { id: "MT_CH", name: "Chinese", category: "MT" }, { id: "MT_MA", name: "Malay", category: "MT" },
            { id: "MT_TA", name: "Tamil", category: "MT" }, { id: "HIST", name: "History", category: "HUM" },
            { id: "GEOG", name: "Geography", category: "HUM" }, { id: "LIT_ENG", name: "Literature in English", category: "HUM" },
            { id: "COMB_HUM", name: "Combined Humanities", category: "HUM" }, { id: "PHY", name: "Physics", category: "SCI" },
            { id: "CHEM", name: "Chemistry", category: "SCI" }, { id: "BIO", name: "Biology", category: "SCI" },
            { id: "COMB_SCI", name: "Combined Science", category: "SCI" }, { id: "ART", name: "Art", category: "AESTHETICS" },
            { id: "DT", name: "Design & Technology", category: "TECH" }, { id: "NFS", name: "Nutrition and Food Science", category: "TECH" },
            { id: "POA", name: "Principles of Accounts", category: "COMMERCE" }, { id: "MUSIC", name: "Music", category: "AESTHETICS" },
            { id: "COMP", name: "Computing/Computer Studies", category: "TECH" }, { id: "OTHER", name: "Other Subject", category: "OTHER" },
        ];

        const SUBJECT_CATEGORIES_DEF = {
            EL: ["EL"], HMT: ["HMT_CH", "HMT_MA", "HMT_TA"], MT: ["MT_CH", "MT_MA", "MT_TA", "HMT_CH", "HMT_MA", "HMT_TA"],
            HUM: ["HIST", "GEOG", "LIT_ENG", "COMB_HUM"], MATH: ["MATH"], MATH_RELATED: ["AM"], SCIENCE: ["PHY", "CHEM", "BIO", "COMB_SCI"],
            TECH_SCI_RELATED: ["DT", "NFS", "COMB_SCI"], ART_HUM_RELATED: ["ART", "GEOG", "HIST", "COMB_HUM", "LIT_ENG", "POA"],
            ANY_BEST: ALL_SUBJECTS_LIST.map(s => s.id)
        };

        // Reordered PATHWAYS array as requested
        const PATHWAYS = [
            { id: "jc", name: "Junior College (JC)", calcType: "L1R4_G3", requirements: { grossL1R4: 16 }, mer: { el_g3: 6, math_am_g3: 7, mt_options: [{ type: "HMT", level: "G3", grade: 8 },{ type: "MT", level: "G3", grade: 7 },{ type: "MT", level: "G2", grade: "5" },{ type: "MT", level: "G1", grade: "D" }] }, l1r4_config: { L1: SUBJECT_CATEGORIES_DEF.EL.concat(SUBJECT_CATEGORIES_DEF.HMT), R1_cat_ids: SUBJECT_CATEGORIES_DEF.HUM, R2_cat_ids: SUBJECT_CATEGORIES_DEF.MATH.concat(SUBJECT_CATEGORIES_DEF.MATH_RELATED).concat(SUBJECT_CATEGORIES_DEF.SCIENCE), R3_cat_ids: SUBJECT_CATEGORIES_DEF.HUM.concat(SUBJECT_CATEGORIES_DEF.MATH).concat(SUBJECT_CATEGORIES_DEF.MATH_RELATED).concat(SUBJECT_CATEGORIES_DEF.SCIENCE), R4_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST, }, description: "L1R4 (G3 subjects) ≤ 16. Must meet Minimum Entry Requirements (MER) for English, Maths, and Mother Tongue." },
            { id: "mi", name: "Millennia Institute (MI)", calcType: "L1R4_G3", requirements: { grossL1R4: 20 }, mer: { el_g3: 6, math_am_g3: 7, mt_options: [{ type: "HMT", level: "G3", grade: 8 },{ type: "MT", level: "G3", grade: 7 },{ type: "MT", level: "G2", grade: "5" },{ type: "MT", level: "G1", grade: "D" }] }, l1r4_config: { L1: SUBJECT_CATEGORIES_DEF.EL.concat(SUBJECT_CATEGORIES_DEF.HMT), R1_cat_ids: SUBJECT_CATEGORIES_DEF.HUM, R2_cat_ids: SUBJECT_CATEGORIES_DEF.MATH.concat(SUBJECT_CATEGORIES_DEF.MATH_RELATED).concat(SUBJECT_CATEGORIES_DEF.SCIENCE), R3_cat_ids: SUBJECT_CATEGORIES_DEF.HUM.concat(SUBJECT_CATEGORIES_DEF.MATH).concat(SUBJECT_CATEGORIES_DEF.MATH_RELATED).concat(SUBJECT_CATEGORIES_DEF.SCIENCE), R4_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST, }, description: "L1R4 (G3 subjects) ≤ 20. Must meet MER." },
            { id: "poly_yr1", name: "Polytechnic Year 1", calcType: "ELR2B2_G3_Mixed", requirements: { netELR2B2: 22 }, merClusters: [ { name: "Science, DET, Nursing Cluster", el_g2: "3", math_am_g2: "3", specific_subj_g2: "3", specific_subj_ids: SUBJECT_CATEGORIES_DEF.TECH_SCI_RELATED, other_two_subj_g2: "4" }, { name: "HAMB, Early Childhood, Tamil Studies Cluster", el_g2: "3", math_am_g2: "3", specific_subj_g2: "3", specific_subj_ids: SUBJECT_CATEGORIES_DEF.ART_HUM_RELATED, other_two_subj_g2: "4" } ], elr2b2_config: { EL: SUBJECT_CATEGORIES_DEF.EL, R_cat_ids: SUBJECT_CATEGORIES_DEF.MATH.concat(SUBJECT_CATEGORIES_DEF.MATH_RELATED).concat(SUBJECT_CATEGORIES_DEF.SCIENCE).concat(SUBJECT_CATEGORIES_DEF.HUM).concat(SUBJECT_CATEGORIES_DEF.TECH_SCI_RELATED).concat(SUBJECT_CATEGORIES_DEF.ART_HUM_RELATED), B_cat_ids: SUBJECT_CATEGORIES_DEF.ANY_BEST, }, description: "Net ELR2B2 ≤ 22 (G3, one B can be G2). Specific MER for course clusters apply (grades are G2 equivalent)." },
            { id: "pfp", name: "Polytechnic Foundation Programme (PFP)", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 12 }, mer: { el_g2: "3", math_am_g2: "3", relevant_subj_g2: "3", relevant_subj_ids: SUBJECT_CATEGORIES_DEF.TECH_SCI_RELATED, other_two_subj_g2: "4" }, description: "Gross ELMAB3 (G2 equivalent grades) ≤ 12. Must meet MER (G2 grades)." },
            { id: "ite_hnitec_yr2", name: "ITE Higher Nitec (Direct Yr 2 Entry)", calcType: "ELMAB3_G2", requirements: { grossELMAB3: 19 }, merClusters: [ { name: "Applied Sciences, Engineering & ICT", el_g2: "4", math_am_g2: "4", any_three_other_subj_g2: "5" }, { name: "Business & Services, Hospitality", el_g2: "3", math_am_g2: "4", any_three_other_subj_g2: "5" } ], description: "Gross ELMAB3 (G2 equivalent grades) ≤ 19. Must meet MER for specific course types (G2 grades)." },
            { id: "ite_hnitec_yr1_g1", name: "ITE Higher Nitec (Year 1 Entry - G1 focus)", calcType: "Best4_G1_Equiv", requirements: { }, mer: { }, description: "Based on best 4 subjects (G1 or G1 equivalent grades A-E/D) and meeting pre-requisites. General MER applies." },
        ];

        // --- State Variables ---
        let studentSubjects = [];
        let bonusPoints = 0;
        let editingIndex = null; // null for add mode, index for edit mode

        // --- DOM Elements ---
        const subjectSelect = document.getElementById('subject');
        const levelSelect = document.getElementById('level');
        const gradeSelect = document.getElementById('grade');
        const bonusInput = document.getElementById('bonus');
        const addUpdateSubjectBtn = document.getElementById('addUpdateSubjectBtn');
        const addUpdateBtnText = addUpdateSubjectBtn.querySelector('span'); // For changing text
        const addUpdateBtnIcon = addUpdateSubjectBtn.querySelector('svg'); // For changing icon
        const studentSubjectsTableBody = document.getElementById('studentSubjectsTableBody');
        const studentSubjectsTableContainer = document.getElementById('studentSubjectsTableContainer');
        const eligibilityResultsContainer = document.getElementById('eligibilityResultsContainer');
        const eligibilityPlaceholder = document.getElementById('eligibilityPlaceholder');
        const improvementSuggestionsSection = document.getElementById('improvementSuggestionsSection');
        const improvementSuggestionsContainer = document.getElementById('improvementSuggestionsContainer');
        const improvementPlaceholder = document.getElementById('improvementPlaceholder');
        const currentYearSpan = document.getElementById('currentYear');

        const customMessageBox = document.getElementById('customMessageBox');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxText = document.getElementById('messageBoxText');
        const messageBoxOkButton = document.getElementById('messageBoxOkButton');

        // --- Utility Functions (Copied and adapted) ---
        const getNumericGrade = (grade, level) => {
            if (level === "G3") return G3_TO_NUMERIC_RAW[grade] || 10;
            if (level === "G2") return G2_TO_NUMERIC_RAW[grade] || 7;
            if (level === "G1") return G1_TO_NUMERIC_RAW_ITE[grade] || 6;
            return Infinity;
        };

        const convertG3toG2 = (g3Grade) => G3_TO_G2_CONVERSION_MAP[g3Grade] || "6";
        const getSubjectById = (id) => ALL_SUBJECTS_LIST.find(s => s.id === id);

        const getStudentSubjectG2Grade = (studentSubject) => {
            if (studentSubject.level === "G2") return studentSubject.grade;
            if (studentSubject.level === "G3") return convertG3toG2(studentSubject.grade);
            return "U"; // If G1 or unknown, return "U" for G2 equivalent
        };

        const getG1Equivalent = (subject) => {
            let g1EquivGrade = null;
            if (subject.level === "G1") {
                if (subject.grade !== "U") g1EquivGrade = subject.grade;
            } else if (subject.level === "G2") {
                if (subject.grade !== "U") g1EquivGrade = G2_TO_G1_EQUIV_MAP[subject.grade];
            } else if (subject.level === "G3") {
                g1EquivGrade = G3_TO_G1_EQUIV_MAP[subject.grade];
            }

            if (g1EquivGrade) {
                const numericG1EquivGrade = G1_TO_NUMERIC_RAW_ITE[g1EquivGrade];
                if (numericG1EquivGrade <= G1_TO_NUMERIC_RAW_ITE["E"]) {
                    return { ...subject, g1EquivGrade, numericG1EquivGrade };
                }
            }
            return { ...subject, g1EquivGrade: null, numericG1EquivGrade: Infinity };
        };
        
        // --- Calculation Functions (Copied and adapted) ---
        const calculateL1R4 = (currentStudentSubjects, config, currentBonusPoints = 0) => {
            const g3Subjects = currentStudentSubjects.filter(s => s.level === "G3" && s.grade !== "U")
                .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level) }))
                .sort((a, b) => a.numericGrade - b.numericGrade);

            let l1Subj, r1Subj, r2Subj, r3Subj, r4Subj;
            let usedIndices = new Set();

            const potentialL1 = g3Subjects.filter(s => config.L1.includes(s.subjectId));
            if (potentialL1.length === 0) return { grossScore: Infinity, netScore: Infinity, details: "Missing L1 (EL/HMT G3)" };
            l1Subj = potentialL1.sort((a,b) => a.numericGrade - b.numericGrade)[0];
            usedIndices.add(g3Subjects.indexOf(l1Subj));

            const findBestR = (categoryIds, currentUsedIndices) => {
                let bestCandidate = null;
                for (let i = 0; i < g3Subjects.length; i++) {
                    if (!currentUsedIndices.has(i) && categoryIds.includes(g3Subjects[i].subjectId)) {
                        if (!bestCandidate || g3Subjects[i].numericGrade < bestCandidate.numericGrade) {
                            bestCandidate = g3Subjects[i];
                        }
                    }
                }
                if (bestCandidate) {
                    currentUsedIndices.add(g3Subjects.indexOf(bestCandidate));
                }
                return bestCandidate;
            };
            
            r1Subj = findBestR(config.R1_cat_ids, usedIndices);
            if (!r1Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R1 (Humanities G3)" };

            r2Subj = findBestR(config.R2_cat_ids, usedIndices);
            if (!r2Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R2 (Math/Science G3)" };

            r3Subj = findBestR(config.R3_cat_ids, usedIndices);
            if (!r3Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R3 (Hum/Math/Sci G3)" };
            
            let r4Candidate = null;
            for (let i = 0; i < g3Subjects.length; i++) {
                if (!usedIndices.has(i) && config.R4_cat_ids.includes(g3Subjects[i].subjectId)) {
                    if (!r4Candidate || g3Subjects[i].numericGrade < r4Candidate.numericGrade) {
                        r4Candidate = g3Subjects[i];
                    }
                }
            }
            r4Subj = r4Candidate;
            if (!r4Subj) return { grossScore: Infinity, netScore: Infinity, details: "Missing R4 (Any other G3, not enough distinct subjects)" };

            const grossScore = l1Subj.numericGrade + r1Subj.numericGrade + r2Subj.numericGrade + r3Subj.numericGrade + r4Subj.numericGrade;
            const netScore = grossScore - currentBonusPoints;
            
            return { grossScore, netScore, subjectsUsed: [l1Subj, r1Subj, r2Subj, r3Subj, r4Subj].map(s=>getSubjectById(s.subjectId)?.name || s.subjectId), details: `L1(${getSubjectById(l1Subj.subjectId)?.name}): ${l1Subj.grade}, R1(${getSubjectById(r1Subj.subjectId)?.name}): ${r1Subj.grade}, R2(${getSubjectById(r2Subj.subjectId)?.name}): ${r2Subj.grade}, R3(${getSubjectById(r3Subj.subjectId)?.name}): ${r3Subj.grade}, R4(${getSubjectById(r4Subj.subjectId)?.name}): ${r4Subj.grade}`};
        };

        const calculateELMAB3_G2 = (currentStudentSubjects, currentBonusPoints = 0) => {
            const subjectsForCalc = currentStudentSubjects.map(s => ({
                ...s, g2Grade: getStudentSubjectG2Grade(s), numericG2Grade: getNumericGrade(getStudentSubjectG2Grade(s), "G2")
            })).filter(s => s.g2Grade !== "U" && s.numericG2Grade <= 6);

            const el = subjectsForCalc.find(s => SUBJECT_CATEGORIES_DEF.EL.includes(s.subjectId));
            const ma = subjectsForCalc.find(s => SUBJECT_CATEGORIES_DEF.MATH.includes(s.subjectId));

            if (!el) return { grossScore: Infinity, netScore: Infinity, details: "Missing English (G2 equiv. pass)" };
            if (!ma) return { grossScore: Infinity, netScore: Infinity, details: "Missing Maths (G2 equiv. pass)" };

            const others = subjectsForCalc.filter(s => s.subjectId !== el.subjectId && s.subjectId !== ma.subjectId)
                .sort((a, b) => a.numericG2Grade - b.numericG2Grade);

            if (others.length < 3) return { grossScore: Infinity, netScore: Infinity, details: `Need 3 other subjects (G2 equiv. pass), found ${others.length}` };

            const b3 = others.slice(0, 3);
            const grossScore = el.numericG2Grade + ma.numericG2Grade + b3.reduce((sum, s) => sum + s.numericG2Grade, 0);
            const netScore = grossScore - currentBonusPoints;
            
            return { grossScore, netScore, subjectsUsed: [el, ma, ...b3].map(s=>getSubjectById(s.subjectId)?.name || s.subjectId), details: `EL(G2 ${el.g2Grade}), MA(G2 ${ma.g2Grade}), B1(${getSubjectById(b3[0].subjectId)?.name} G2 ${b3[0].g2Grade}), B2(${getSubjectById(b3[1].subjectId)?.name} G2 ${b3[1].g2Grade}), B3(${getSubjectById(b3[2].subjectId)?.name} G2 ${b3[2].g2Grade})`};
        };

        const calculateELR2B2_G3_Mixed = (currentStudentSubjects, config, currentBonusPoints = 0) => {
            const g3SubjectsForCalc = currentStudentSubjects.filter(s => s.level === "G3" && s.grade !== "U")
                .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level) }));
            const g2SubjectsForCalc = currentStudentSubjects.filter(s => s.level === "G2" && s.grade !== "U")
                .map(s => ({ ...s, numericGrade: getNumericGrade(s.grade, s.level) }));

            const el_g3 = g3SubjectsForCalc.find(s => SUBJECT_CATEGORIES_DEF.EL.includes(s.subjectId));
            if (!el_g3) return { grossScore: Infinity, netScore: Infinity, details: "Missing English (G3)" };

            let relevantRSubjects = [];
            let bestBSubjects = [];
            let usedSubjectIds = new Set([el_g3.subjectId]);

            // R1 and R2 from G3 subjects
            const potentialR = g3SubjectsForCalc
                .filter(s => !usedSubjectIds.has(s.subjectId) && config.R_cat_ids.includes(s.subjectId))
                .sort((a, b) => a.numericGrade - b.numericGrade);
            relevantRSubjects = potentialR.slice(0, 2);
            relevantRSubjects.forEach(s => usedSubjectIds.add(s.subjectId));

            if (relevantRSubjects.length < 2) return { grossScore: Infinity, netScore: Infinity, details: `Need 2 R subjects (G3), found ${relevantRSubjects.length}` };

            // B1 and B2 can be G3 or one G2 (G2 only if it's better than a G3 B subject)
            const potentialB_G3 = g3SubjectsForCalc
                .filter(s => !usedSubjectIds.has(s.subjectId) && config.B_cat_ids.includes(s.subjectId))
                .sort((a, b) => a.numericGrade - b.numericGrade);

            const potentialB_G2 = g2SubjectsForCalc
                .filter(s => !usedSubjectIds.has(s.subjectId) && config.B_cat_ids.includes(s.subjectId))
                .sort((a, b) => a.numericG2Grade - b.numericG2Grade); // Changed to numericG2Grade for G2 comparison

            let candidatesForB = [...potentialB_G3];
            let g2UsedAsB = null; // To track if a G2 subject was used for B

            // Logic to potentially use a G2 subject if it improves the score
            if (potentialB_G3.length < 2 && potentialB_G2.length > 0) {
                // If not enough G3 B subjects, try to use the best G2 B subject
                g2UsedAsB = potentialB_G2[0];
                candidatesForB.push({ ...g2UsedAsB, originalLevel: "G2", numericGrade: getNumericGrade(g2UsedAsB.grade, "G2") });
            } else if (potentialB_G3.length >= 2 && potentialB_G2.length > 0) {
                // If there are at least two G3 B subjects, check if the best G2 B subject is better than the worst G3 B subject
                const worstG3B = potentialB_G3[potentialB_G3.length -1]; // Last element after sorting
                if (getNumericGrade(potentialB_G2[0].grade, "G2") < worstG3B.numericGrade) {
                    // If the best G2 subject is better, replace the worst G3 B subject with it
                    candidatesForB.pop(); // Remove the worst G3 B subject
                    g2UsedAsB = potentialB_G2[0];
                    candidatesForB.push({ ...g2UsedAsB, originalLevel: "G2", numericGrade: getNumericGrade(g2UsedAsB.grade, "G2") });
                }
            }

            candidatesForB.sort((a,b) => a.numericGrade - b.numericGrade);
            bestBSubjects = candidatesForB.slice(0,2);

            let scoreSubjects = [el_g3, ...relevantRSubjects, ...bestBSubjects];
            if (scoreSubjects.length < 5 || !relevantRSubjects[0] || !relevantRSubjects[1] || !bestBSubjects[0] || !bestBSubjects[1]) {
                return { grossScore: Infinity, netScore: Infinity, details: "Not enough subjects to calculate ELR2B2" };
            }
            
            const grossScore = scoreSubjects.reduce((sum, s) => sum + s.numericGrade, 0);
            const netScore = grossScore - currentBonusPoints;
            
            const subjectsUsedDetails = `EL(G3 ${el_g3.grade}), R1(${getSubjectById(relevantRSubjects[0].subjectId)?.name} G3 ${relevantRSubjects[0].grade}), R2(${getSubjectById(relevantRSubjects[1].subjectId)?.name} G3 ${relevantRSubjects[1].grade}), B1(${getSubjectById(bestBSubjects[0].subjectId)?.name} ${bestBSubjects[0].originalLevel || 'G3'} ${bestBSubjects[0].grade}), B2(${getSubjectById(bestBSubjects[1].subjectId)?.name} ${bestBSubjects[1].originalLevel || 'G3'} ${bestBSubjects[1].grade})`;

            return { grossScore, netScore, subjectsUsed: scoreSubjects.map(s=>getSubjectById(s.subjectId)?.name || s.subjectId), details: subjectsUsedDetails };
        };

        const calculateBest4_G1_Equiv = (currentStudentSubjects, currentBonusPoints = 0) => {
            const g1EquivSubjects = currentStudentSubjects
                .map(getG1Equivalent)
                .filter(s => s.numericG1EquivGrade <= G1_TO_NUMERIC_RAW_ITE["E"]) // Only pass grades (A-E/D)
                .sort((a, b) => a.numericG1EquivGrade - b.numericG1EquivGrade);

            if (g1EquivSubjects.length < 4) {
                return { grossScore: Infinity, netScore: Infinity, details: `Need 4 subjects (G1 equiv. A-E/D pass), found ${g1EquivSubjects.length}` };
            }

            const best4 = g1EquivSubjects.slice(0, 4);
            const grossScore = best4.reduce((sum, s) => sum + s.numericG1EquivGrade, 0);
            const netScore = grossScore - currentBonusPoints; // Bonus points typically not applied for ITE Best 4, but included for consistency if needed.

            const subjectsUsedDetails = best4.map(s => `${getSubjectById(s.subjectId)?.name} (G1 equiv ${s.g1EquivGrade})`).join(", ");

            return { grossScore, netScore, subjectsUsed: best4.map(s=>getSubjectById(s.subjectId)?.name || s.subjectId), details: subjectsUsedDetails };
        };

        const checkMerRequirements = (pathway, studentSubjectsMap, bonusPoints) => {
            const mer = pathway.mer;
            const merClusters = pathway.merClusters;
            let merMet = true;
            let merDetails = [];
            
            const getSubjectGradeForMer = (subjectId, requiredLevel) => {
                const subject = studentSubjectsMap.get(subjectId);
                if (!subject) return Infinity;
                if (requiredLevel === "G3" && subject.level === "G3") return getNumericGrade(subject.grade, "G3");
                if (requiredLevel === "G2") return getNumericGrade(getStudentSubjectG2Grade(subject), "G2");
                if (requiredLevel === "G1") {
                    const g1Equiv = getG1Equivalent(subject);
                    return g1Equiv.numericG1EquivGrade;
                }
                return Infinity;
            };

            const getSubjectGradeDisplay = (subjectId, grade, level) => {
                const subjectName = getSubjectById(subjectId)?.name || subjectId;
                return `${subjectName}: ${grade} (${level})`;
            };

            // Common MER for JC/MI
            if (mer && pathway.calcType === "L1R4_G3") {
                const el = studentSubjectsMap.get("EL");
                const math = studentSubjectsMap.get("MATH");
                const am = studentSubjectsMap.get("AM");
                let mtOptionMet = false;
                let mtDetails = [];

                // Check English
                if (el && getNumericGrade(el.grade, "G3") <= mer.el_g3) {
                    merDetails.push(`English: ${el.grade} (Met)`);
                } else {
                    merMet = false;
                    merDetails.push(`English: ${el?.grade || 'N/A'} (Required G3 ≤ ${mer.el_g3})`);
                }

                // Check Math/Add Math
                let mathGrade = Infinity;
                let mathDisplay = 'N/A';
                if (math && getNumericGrade(math.grade, "G3") <= mer.math_am_g3) {
                    mathGrade = getNumericGrade(math.grade, "G3");
                    mathDisplay = getSubjectGradeDisplay("MATH", math.grade, "G3");
                }
                if (am && getNumericGrade(am.grade, "G3") <= mer.math_am_g3 && getNumericGrade(am.grade, "G3") < mathGrade) {
                    mathGrade = getNumericGrade(am.grade, "G3");
                    mathDisplay = getSubjectGradeDisplay("AM", am.grade, "G3");
                }
                if (mathGrade <= mer.math_am_g3) {
                    merDetails.push(`${mathDisplay} (Met)`);
                } else {
                    merMet = false;
                    merDetails.push(`Math/Add Math: ${mathDisplay} (Required G3 ≤ ${mer.math_am_g3})`);
                }

                // Check Mother Tongue options
                for (const option of mer.mt_options) {
                    const mtSubj = studentSubjects.find(s => SUBJECT_CATEGORIES_DEF[option.type].includes(s.subjectId));
                    if (mtSubj) {
                        let gradeToCompare = null;
                        if (option.level === "G3") gradeToCompare = getNumericGrade(mtSubj.grade, "G3");
                        else if (option.level === "G2") gradeToCompare = getNumericGrade(getStudentSubjectG2Grade(mtSubj), "G2");
                        else if (option.level === "G1") gradeToCompare = getG1Equivalent(mtSubj).numericG1EquivGrade;

                        if (gradeToCompare !== null && gradeToCompare <= getNumericGrade(option.grade, option.level)) {
                            mtOptionMet = true;
                            mtDetails.push(`${getSubjectById(mtSubj.subjectId)?.name} (${mtSubj.level} ${mtSubj.grade} / ${option.level} equiv. ${option.grade}) (Met)`);
                            break;
                        } else {
                            mtDetails.push(`${getSubjectById(mtSubj.subjectId)?.name} (${mtSubj.level} ${mtSubj.grade} / ${option.level} equiv. required ${option.grade})`);
                        }
                    }
                }
                if (!mtOptionMet) {
                    merMet = false;
                    merDetails.push(`Mother Tongue: No option met. Options considered: ${mtDetails.join("; ")}`);
                } else {
                    merDetails.push(`Mother Tongue: One option met (${mtDetails.find(d => d.includes('(Met)'))})`);
                }
            }
            
            // MER for Polytechnic Year 1 (ELR2B2_G3_Mixed) and ITE Higher Nitec (ELMAB3_G2)
            if (merClusters) {
                let bestClusterMet = false;
                let clusterResults = [];

                for (const cluster of merClusters) {
                    let clusterMet = true;
                    let currentClusterDetails = [];

                    // Check EL
                    const elGrade = getSubjectGradeForMer("EL", "G2");
                    if (elGrade <= getNumericGrade(cluster.el_g2, "G2")) {
                        currentClusterDetails.push(`English (G2 equiv): ${getStudentSubjectG2Grade(studentSubjectsMap.get("EL"))} (Met)`);
                    } else {
                        clusterMet = false;
                        currentClusterDetails.push(`English (G2 equiv): ${getStudentSubjectG2Grade(studentSubjectsMap.get("EL")) || 'N/A'} (Required G2 ≤ ${cluster.el_g2})`);
                    }

                    // Check Math/Add Math
                    const mathGrade = getSubjectGradeForMer("MATH", "G2");
                    const amGrade = getSubjectGradeForMer("AM", "G2");
                    let effectiveMathGrade = Infinity;
                    let mathDisplay = 'N/A';
                    if (mathGrade <= getNumericGrade(cluster.math_am_g2, "G2")) {
                        effectiveMathGrade = mathGrade;
                        mathDisplay = getStudentSubjectG2Grade(studentSubjectsMap.get("MATH"));
                    }
                    if (amGrade <= getNumericGrade(cluster.math_am_g2, "G2") && amGrade < effectiveMathGrade) {
                        effectiveMathGrade = amGrade;
                        mathDisplay = getStudentSubjectG2Grade(studentSubjectsMap.get("AM"));
                    }

                    if (effectiveMathGrade <= getNumericGrade(cluster.math_am_g2, "G2")) {
                        currentClusterDetails.push(`Math/Add Math (G2 equiv): ${mathDisplay} (Met)`);
                    } else {
                        clusterMet = false;
                        currentClusterDetails.push(`Math/Add Math (G2 equiv): ${mathDisplay} (Required G2 ≤ ${cluster.math_am_g2})`);
                    }

                    // Check specific subject for Poly Yr1 or 3 other subjects for ITE Hnitec
                    if (cluster.specific_subj_ids) { // For Polytechnic Year 1 specific clusters
                        const specificSubjMet = studentSubjects.some(subj => 
                            cluster.specific_subj_ids.includes(subj.subjectId) && 
                            getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(cluster.specific_subj_g2, "G2")
                        );
                        if (specificSubjMet) {
                            currentClusterDetails.push(`Specific Subject (G2 equiv): Met (Required G2 ≤ ${cluster.specific_subj_g2})`);
                        } else {
                            clusterMet = false;
                            currentClusterDetails.push(`Specific Subject (G2 equiv): Not Met (Required G2 ≤ ${cluster.specific_subj_g2} from ${cluster.specific_subj_ids.join(', ')})`);
                        }
                    } else if (cluster.any_three_other_subj_g2) { // For ITE Higher Nitec any 3 other subjects
                        const otherSubjectsCount = studentSubjects.filter(subj =>
                            subj.subjectId !== "EL" && subj.subjectId !== "MATH" && subj.subjectId !== "AM" &&
                            getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(cluster.any_three_other_subj_g2, "G2")
                        ).length;

                        if (otherSubjectsCount >= 3) {
                            currentClusterDetails.push(`3 other subjects (G2 equiv): Met (${otherSubjectsCount} subjects at G2 ≤ ${cluster.any_three_other_subj_g2})`);
                        } else {
                            clusterMet = false;
                            currentClusterDetails.push(`3 other subjects (G2 equiv): Not Met (Need 3, found ${otherSubjectsCount} at G2 ≤ ${cluster.any_three_other_subj_g2})`);
                        }
                    } else if (cluster.other_two_subj_g2) { // For PFP other two subjects
                        const eligibleOtherSubjects = studentSubjects.filter(subj =>
                            subj.subjectId !== "EL" && subj.subjectId !== "MATH" && subj.subjectId !== "AM" &&
                            !cluster.relevant_subj_ids?.includes(subj.subjectId) && // Exclude relevant subject if it's PFP
                            getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(cluster.other_two_subj_g2, "G2")
                        ).length;
                        
                        if (eligibleOtherSubjects >= 2) {
                            currentClusterDetails.push(`2 other subjects (G2 equiv): Met (${eligibleOtherSubjects} subjects at G2 ≤ ${cluster.other_two_subj_g2})`);
                        } else {
                            clusterMet = false;
                            currentClusterDetails.push(`2 other subjects (G2 equiv): Not Met (Need 2, found ${eligibleOtherSubjects} at G2 ≤ ${cluster.other_two_subj_g2})`);
                        }
                    }

                    clusterResults.push({ name: cluster.name, met: clusterMet, details: currentClusterDetails });
                    if (clusterMet) {
                        bestClusterMet = true;
                    }
                }
                merMet = bestClusterMet;
                merDetails = clusterResults;
            }

            // PFP specific MER
            if (mer && pathway.id === "pfp") {
                const el = studentSubjectsMap.get("EL");
                const math = studentSubjectsMap.get("MATH");

                // Check EL
                if (el && getNumericGrade(getStudentSubjectG2Grade(el), "G2") <= getNumericGrade(mer.el_g2, "G2")) {
                    merDetails.push(`English (G2 equiv): ${getStudentSubjectG2Grade(el)} (Met)`);
                } else {
                    merMet = false;
                    merDetails.push(`English (G2 equiv): ${getStudentSubjectG2Grade(el) || 'N/A'} (Required G2 ≤ ${mer.el_g2})`);
                }

                // Check Math/Add Math
                const mathGrade = getSubjectGradeForMer("MATH", "G2");
                const amGrade = getSubjectGradeForMer("AM", "G2");
                let effectiveMathGrade = Infinity;
                let mathDisplay = 'N/A';
                if (mathGrade <= getNumericGrade(mer.math_am_g2, "G2")) {
                    effectiveMathGrade = mathGrade;
                    mathDisplay = getStudentSubjectG2Grade(studentSubjectsMap.get("MATH"));
                }
                if (amGrade <= getNumericGrade(mer.math_am_g2, "G2") && amGrade < effectiveMathGrade) {
                    effectiveMathGrade = amGrade;
                    mathDisplay = getStudentSubjectG2Grade(studentSubjectsMap.get("AM"));
                }
                if (effectiveMathGrade <= getNumericGrade(mer.math_am_g2, "G2")) {
                    merDetails.push(`Math/Add Math (G2 equiv): ${mathDisplay} (Met)`);
                } else {
                    merMet = false;
                    merDetails.push(`Math/Add Math (G2 equiv): ${mathDisplay} (Required G2 ≤ ${mer.math_am_g2})`);
                }

                // Check relevant subject
                const relevantSubjMet = studentSubjects.some(subj => 
                    mer.relevant_subj_ids.includes(subj.subjectId) && 
                    getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(mer.relevant_subj_g2, "G2")
                );
                if (relevantSubjMet) {
                    merDetails.push(`Relevant Subject (G2 equiv): Met (Required G2 ≤ ${mer.relevant_subj_g2})`);
                } else {
                    merMet = false;
                    merDetails.push(`Relevant Subject (G2 equiv): Not Met (Required G2 ≤ ${mer.relevant_subj_g2} from ${mer.relevant_subj_ids.join(', ')})`);
                }

                // Check other two subjects
                const eligibleOtherSubjects = studentSubjects.filter(subj =>
                    subj.subjectId !== "EL" && subj.subjectId !== "MATH" && subj.subjectId !== "AM" &&
                    !mer.relevant_subj_ids.includes(subj.subjectId) &&
                    getNumericGrade(getStudentSubjectG2Grade(subj), "G2") <= getNumericGrade(mer.other_two_subj_g2, "G2")
                ).length;
                
                if (eligibleOtherSubjects >= 2) {
                    merDetails.push(`2 other subjects (G2 equiv): Met (${eligibleOtherSubjects} subjects at G2 ≤ ${mer.other_two_subj_g2})`);
                } else {
                    merMet = false;
                    merDetails.push(`2 other subjects (G2 equiv): Not Met (Need 2, found ${eligibleOtherSubjects} at G2 ≤ ${mer.other_two_subj_g2})`);
                }
            }

            // ITE Hnitec (Year 1 Entry - G1 focus) has general MER for admission
            if (pathway.id === "ite_hnitec_yr1_g1") {
                // General MER: Need a pass in EL, and at least a pass in 3 other subjects (G1 equivalent, D or better)
                const el = studentSubjectsMap.get("EL");
                let elPassed = false;
                if (el) {
                    const g1EquivEL = getG1Equivalent(el);
                    if (g1EquivEL.numericG1EquivGrade <= G1_TO_NUMERIC_RAW_ITE["D"]) { // G1 equiv D or better
                        elPassed = true;
                        merDetails.push(`English (G1 equiv): ${g1EquivEL.g1EquivGrade} (Met)`);
                    } else {
                        merDetails.push(`English (G1 equiv): ${g1EquivEL.g1EquivGrade || 'N/A'} (Required G1 equiv ≤ D)`);
                    }
                } else {
                    merDetails.push(`English (G1 equiv): N/A (Required G1 equiv ≤ D)`);
                }

                const otherPassedSubjectsCount = studentSubjects.filter(subj =>
                    subj.subjectId !== "EL" && getG1Equivalent(subj).numericG1EquivGrade <= G1_TO_NUMERIC_RAW_ITE["D"]
                ).length;

                if (otherPassedSubjectsCount >= 3) {
                    merDetails.push(`3 other subjects (G1 equiv): Met (${otherPassedSubjectsCount} subjects at G1 equiv ≤ D)`);
                } else {
                    merDetails.push(`3 other subjects (G1 equiv): Not Met (Need 3, found ${otherPassedSubjectsCount} at G1 equiv ≤ D)`);
                }
                
                if (!elPassed || otherPassedSubjectsCount < 3) {
                    merMet = false;
                }
            }


            return { merMet, merDetails };
        };

        const checkEligibility = () => {
            // Check if there are enough subjects for any pathway calculation
            // A common minimum is 5 subjects for most aggregate calculations (L1R4, ELMAB3, ELR2B2)
            if (studentSubjects.length < 5) {
                renderEligibilityResults([]); // Render empty results or placeholder if not enough subjects
                return;
            }

            const allPathwaysStatus = []; // Changed to store status for ALL pathways
            const studentSubjectsMap = new Map(studentSubjects.map(s => [s.subjectId, s]));

            // Iterate through PATHWAYS in their defined order
            PATHWAYS.forEach(pathway => {
                let result = { grossScore: Infinity, netScore: Infinity, details: "N/A", subjectsUsed: [] };
                // Perform calculation based on pathway type
                if (pathway.calcType === "L1R4_G3") {
                    result = calculateL1R4(studentSubjects, pathway.l1r4_config, bonusPoints);
                } else if (pathway.calcType === "ELMAB3_G2") {
                    result = calculateELMAB3_G2(studentSubjects, bonusPoints);
                } else if (pathway.calcType === "ELR2B2_G3_Mixed") {
                    result = calculateELR2B2_G3_Mixed(studentSubjects, pathway.elr2b2_config, bonusPoints);
                } else if (pathway.calcType === "Best4_G1_Equiv") {
                    result = calculateBest4_G1_Equiv(studentSubjects, bonusPoints);
                }

                // Determine if score requirement is met
                let scoreMet = false;
                if (result.grossScore !== Infinity) { // Only check if calculation was successful
                    if (pathway.requirements.grossL1R4 !== undefined) {
                        scoreMet = result.grossScore <= pathway.requirements.grossL1R4;
                    } else if (pathway.requirements.netELR2B2 !== undefined) {
                        scoreMet = result.netScore <= pathway.requirements.netELR2B2;
                    } else if (pathway.requirements.grossELMAB3 !== undefined) {
                        scoreMet = result.grossScore <= pathway.requirements.grossELMAB3;
                    } else if (pathway.id === "ite_hnitec_yr1_g1") {
                        scoreMet = result.grossScore < Infinity; // For Best4, it's about having enough passing subjects
                    }
                }
                
                const merCheck = checkMerRequirements(pathway, studentSubjectsMap, bonusPoints);

                // Always add the pathway to the list, regardless of eligibility
                allPathwaysStatus.push({
                    ...pathway,
                    grossScore: result.grossScore,
                    netScore: result.netScore,
                    scoreDetails: result.details,
                    scoreMet: scoreMet,
                    merCheck: merCheck,
                    subjectsUsed: result.subjectsUsed,
                });
            });
            renderEligibilityResults(allPathwaysStatus); // Pass all pathways for rendering
        };
        
        // --- Rendering Functions ---
        function showMessage(message, title = "Notification") {
            messageBoxTitle.textContent = title;
            messageBoxText.textContent = message;
            customMessageBox.classList.remove('hidden');
        }
        
        messageBoxOkButton.addEventListener('click', () => {
            customMessageBox.classList.add('hidden');
        });


        function populateSubjectDropdown() {
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            ALL_SUBJECTS_LIST.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.name;
                subjectSelect.appendChild(option);
            });
        }

        function populateLevelDropdown() {
            levelSelect.innerHTML = '';
            GRADE_LEVELS.forEach(l => {
                const option = document.createElement('option');
                option.value = l;
                option.textContent = l;
                levelSelect.appendChild(option);
            });
            levelSelect.value = 'G3'; // Default
        }

        function populateGradeDropdown(level) {
            gradeSelect.innerHTML = '<option value="">Select Grade</option>'; // Clear existing
            let grades = [];
            if (level === 'G3') grades = G3_GRADES_OPTIONS;
            else if (level === 'G2') grades = G2_GRADES_OPTIONS;
            else if (level === 'G1') grades = G1_GRADES_OPTIONS;

            grades.forEach(g => {
                const option = document.createElement('option');
                option.value = g;
                option.textContent = g;
                gradeSelect.appendChild(option);
            });
            if (grades.length > 0) gradeSelect.value = grades[0];
            gradeSelect.disabled = grades.length === 0;
        }

        // Helper to populate grade dropdown for a specific row
        const populateRowGradeDropdown = (selectElement, level, selectedGrade) => {
            selectElement.innerHTML = '';
            let grades = [];
            if (level === 'G3') grades = G3_GRADES_OPTIONS;
            else if (level === 'G2') grades = G2_GRADES_OPTIONS;
            else if (level === 'G1') grades = G1_GRADES_OPTIONS;

            grades.forEach(g => {
                const option = document.createElement('option');
                option.value = g;
                option.textContent = g;
                if (g === selectedGrade) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
            selectElement.disabled = grades.length === 0;
        };


        function renderStudentSubjectsTable() {
            studentSubjectsTableBody.innerHTML = ''; // Clear existing rows
            if (studentSubjects.length === 0) {
                studentSubjectsTableContainer.classList.add('hidden');
                return;
            }
            studentSubjectsTableContainer.classList.remove('hidden');

            studentSubjects.forEach((s, index) => {
                const row = studentSubjectsTableBody.insertRow();
                row.className = 'hover:bg-slate-700/50 transition-colors';
                
                // Subject Name Cell
                row.insertCell().outerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">${getSubjectById(s.subjectId)?.name || s.subjectId}</td>`;
                
                // Level Dropdown Cell
                const levelCell = row.insertCell();
                levelCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-300";
                const levelSelectEl = document.createElement('select');
                levelSelectEl.className = "w-full p-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100 text-sm";
                GRADE_LEVELS.forEach(levelOption => {
                    const option = document.createElement('option');
                    option.value = levelOption;
                    option.textContent = levelOption;
                    if (levelOption === s.level) {
                        option.selected = true;
                    }
                    levelSelectEl.appendChild(option);
                });
                levelSelectEl.onchange = (e) => {
                    const newLevel = e.target.value;
                    studentSubjects[index].level = newLevel;

                    // Determine the first valid grade for the new level
                    let defaultNewGrade = "";
                    if (newLevel === 'G3') defaultNewGrade = G3_GRADES_OPTIONS[0];
                    else if (newLevel === 'G2') defaultNewGrade = G2_GRADES_OPTIONS[0];
                    else if (newLevel === 'G1') defaultNewGrade = G1_GRADES_OPTIONS[0];
                    
                    studentSubjects[index].grade = defaultNewGrade; // Update the array with a valid grade

                    // Re-populate grade dropdown for this row based on new level and set its value
                    const gradeSelectEl = row.querySelector('.grade-select');
                    populateRowGradeDropdown(gradeSelectEl, newLevel, defaultNewGrade); // Pass the new default grade
                    
                    updateAllCalculationsAndRender();
                };
                levelCell.appendChild(levelSelectEl);

                // Grade Dropdown Cell
                const gradeCell = row.insertCell();
                gradeCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-300";
                const gradeSelectEl = document.createElement('select');
                gradeSelectEl.className = "grade-select w-full p-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 text-gray-100 text-sm";
                populateRowGradeDropdown(gradeSelectEl, s.level, s.grade); // Initial population
                gradeSelectEl.onchange = (e) => {
                    studentSubjects[index].grade = e.target.value;
                    updateAllCalculationsAndRender();
                };
                gradeCell.appendChild(gradeSelectEl);
                
                // Actions Cell (only delete button)
                const actionsCell = row.insertCell();
                actionsCell.className = "px-6 py-4 whitespace-nowrap text-sm font-medium text-right";
                actionsCell.innerHTML = `
                    <button onclick="handleDeleteSubject(${index})" class="text-red-400 hover:text-red-300 transition-colors" aria-label="Delete subject">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm"><path d="M6 7H18V20C18 20.552 17.552 21 17 21H7C6.448 21 6 20.552 6 20V7Z"></path><path d="M19 4H15V3C15 2.448 14.552 2 14 2H10C9.448 2 9 2.448 9 3V4H5V6H19V4Z"></path></svg>
                    </button>
                `;
            });
        }
        
        function renderEligibilityResults(eligibilityResults) {
            eligibilityResultsContainer.innerHTML = ''; // Clear existing
            if (studentSubjects.length === 0) {
                eligibilityPlaceholder.classList.remove('hidden');
                eligibilityResultsContainer.innerHTML = ''; // Clear previous results
                eligibilityResultsContainer.appendChild(eligibilityPlaceholder);
                return;
            }
            eligibilityPlaceholder.classList.add('hidden');

            eligibilityResults.forEach(pathway => {
                const card = document.createElement('div');
                // Determine card color based on both score and MER eligibility
                const isEligible = pathway.scoreMet && pathway.merCheck.merMet;
                card.className = `p-5 rounded-lg shadow-lg border ${isEligible ? 'bg-emerald-800/30 border-emerald-600' : 'bg-red-800/30 border-red-600'} transition-all hover:shadow-xl hover:scale-[1.02]`;
                
                let scoreText = '';
                // Only display calculated score if it's not Infinity (meaning calculation was possible)
                if (pathway.grossScore !== Infinity) {
                     scoreText = `<p class="text-xs text-slate-400 mb-1">
                        Calculated Score (${pathway.calcType.startsWith("L1R4") ? 'Gross L1R4' : (pathway.calcType.startsWith("ELR2B2")? 'Net ELR2B2' : 'Gross ELMAB3')}): ${pathway.grossScore}
                    </p>`;
                } else {
                    scoreText = `<p class="text-xs text-slate-400 mb-1">Score: N/A (Missing prerequisite subjects or grades)</p>`;
                }


                const reasonsList = pathway.merCheck.merDetails.map(detail => {
                    if (typeof detail === 'object' && detail.name) { // For clusters
                        const clusterStatus = detail.met ? 'Met' : 'Not Met';
                        const clusterColor = detail.met ? 'text-emerald-300' : 'text-rose-300';
                        return `
                            <li class="mb-1">
                                <span class="${clusterColor}">${detail.name}: ${clusterStatus}</span>
                                <ul class="ml-4 list-disc list-inside text-slate-400 text-xs mt-0.5">
                                    ${detail.details.map(d => `<li>${d}</li>`).join('')}
                                </ul>
                            </li>`;
                    }
                    return `<li class="mb-0.5 text-slate-400">${detail}</li>`;
                }).join('');

                const descriptionItem = pathway.description ? `<li class="mt-2 pt-2 border-t border-slate-700 text-slate-400 italic">${pathway.description}</li>` : '';

                card.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2 flex items-center">
                        ${isEligible ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2 text-emerald-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-2 text-red-400"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"></path></svg>'}
                        ${pathway.name}
                    </h3>
                    <p class="text-sm mb-1 font-medium ${isEligible ? 'text-emerald-300' : 'text-red-300'}">
                        Status: ${isEligible ? 'Eligible' : 'Not Eligible'}
                    </p>
                    ${scoreText}
                    <details class="text-xs mt-2">
                        <summary class="cursor-pointer text-sky-400 hover:text-sky-300">Details & Reasons</summary>
                        <ul class="list-disc list-inside mt-1 pl-2 text-slate-300 space-y-1">
                            ${reasonsList}
                            ${descriptionItem}
                        </ul>
                    </details>
                `;
                eligibilityResultsContainer.appendChild(card);
            });
        };

        const getNextBetterGrade = (currentGrade, level) => {
            let gradesList = [];
            let currentGradeIndex = -1;

            if (level === "G3") {
                gradesList = G3_GRADES_OPTIONS;
                currentGradeIndex = gradesList.indexOf(currentGrade);
            } else if (level === "G2") {
                gradesList = G2_GRADES_OPTIONS;
                currentGradeIndex = gradesList.indexOf(currentGrade);
            } else if (level === "G1") {
                gradesList = G1_GRADES_OPTIONS;
                currentGradeIndex = gradesList.indexOf(currentGrade);
            }

            // If current grade is 'U' or already the best possible grade (index 0), no improvement possible
            if (currentGradeIndex === -1 || currentGradeIndex === 0) {
                return null;
            }
            // The next better grade is simply the previous one in the sorted list
            return gradesList[currentGradeIndex - 1];
        };

        const getEligiblePathwayCountAndNames = (subjects) => {
            let count = 0;
            const pathwayNames = [];
            const studentSubjectsMap = new Map(subjects.map(s => [s.subjectId, s]));

            PATHWAYS.forEach(pathway => {
                let result = { grossScore: Infinity, netScore: Infinity };
                if (pathway.calcType === "L1R4_G3") {
                    result = calculateL1R4(subjects, pathway.l1r4_config, bonusPoints);
                } else if (pathway.calcType === "ELMAB3_G2") {
                    result = calculateELMAB3_G2(subjects, bonusPoints);
                } else if (pathway.calcType === "ELR2B2_G3_Mixed") {
                    result = calculateELR2B2_G3_Mixed(subjects, pathway.elr2b2_config, bonusPoints);
                } else if (pathway.calcType === "Best4_G1_Equiv") {
                    result = calculateBest4_G1_Equiv(subjects, bonusPoints);
                }

                const scoreMet = (pathway.requirements.grossL1R4 !== undefined && result.grossScore <= pathway.requirements.grossL1R4) ||
                                 (pathway.requirements.netELR2B2 !== undefined && result.netScore <= pathway.requirements.netELR2B2) ||
                                 (pathway.requirements.grossELMAB3 !== undefined && result.grossScore <= pathway.requirements.grossELMAB3) ||
                                 (pathway.id === "ite_hnitec_yr1_g1" && result.grossScore < Infinity);

                const merCheck = checkMerRequirements(pathway, studentSubjectsMap, bonusPoints);
                if (scoreMet && merCheck.merMet) {
                    count++;
                    pathwayNames.push(pathway.name);
                }
            });
            return { count, pathwayNames };
        };

        const generateImprovementSuggestions = () => {
            improvementSuggestionsContainer.innerHTML = '';
            if (studentSubjects.length === 0) {
                improvementSuggestionsSection.classList.add('hidden');
                return;
            }

            improvementSuggestionsSection.classList.remove('hidden');
            improvementPlaceholder.classList.add('hidden');

            const { count: currentEligiblePathwaysCount, pathwayNames: currentEligiblePathwayNames } = getEligiblePathwayCountAndNames(studentSubjects);
            const suggestions = [];

            studentSubjects.forEach((subject, index) => {
                const originalGrade = subject.grade;
                const originalLevel = subject.level;
                const nextBetterGrade = getNextBetterGrade(originalGrade, originalLevel);

                if (nextBetterGrade) {
                    const tempSubjects = [...studentSubjects];
                    tempSubjects[index] = { ...subject, grade: nextBetterGrade };
                    const { count: newEligiblePathwaysCount, pathwayNames: newEligiblePathwayNames } = getEligiblePathwayCountAndNames(tempSubjects);

                    if (newEligiblePathwaysCount > currentEligiblePathwaysCount) {
                        const unlockedPathwayNames = newEligiblePathwayNames.filter(name => !currentEligiblePathwayNames.includes(name));
                        suggestions.push({
                            subjectName: getSubjectById(subject.subjectId).name,
                            originalGrade: originalGrade,
                            originalLevel: originalLevel,
                            improvedGrade: nextBetterGrade,
                            pathwaysUnlockedCount: newEligiblePathwaysCount - currentEligiblePathwaysCount,
                            unlockedPathwayNames: unlockedPathwayNames,
                        });
                    }
                }
            });

            if (suggestions.length === 0) {
                improvementPlaceholder.classList.remove('hidden');
                improvementSuggestionsSection.classList.remove('hidden'); // Ensure section is visible even if no suggestions, to show the "doing great" message
            } else {
                renderImprovementSuggestions(suggestions);
            }
        };

        const renderImprovementSuggestions = (suggestions) => {
            improvementSuggestionsContainer.innerHTML = '';
            suggestions.sort((a, b) => b.pathwaysUnlockedCount - a.pathwaysUnlockedCount); // Sort by most pathways unlocked

            suggestions.forEach(suggestion => {
                const pathwayNamesText = suggestion.unlockedPathwayNames.length > 0
                    ? `This could unlock: <strong>${suggestion.unlockedPathwayNames.join(', ')}</strong>.`
                    : `This could unlock <strong>${suggestion.pathwaysUnlockedCount}</strong> additional pathway(s).`;

                const suggestionCard = `
                    <div class="bg-slate-700 p-4 rounded-lg shadow-md mb-3 border border-slate-600 flex items-start">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-md mr-3 text-emerald-400 flex-shrink-0 mt-1"><path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM16.59 7.58L10 14.17L7.41 11.59L6 13L10 17L18 9L16.59 7.58Z"></path></svg>
                        <div>
                            <h4 class="text-lg font-semibold text-sky-300 mb-1">${getSubjectById(suggestion.subjectName)?.name || suggestion.subjectName}</h4>
                            <p class="text-slate-200 text-sm mb-2">Improve from <strong>${suggestion.originalGrade} (${suggestion.originalLevel})</strong> to <strong>${suggestion.improvedGrade} (${suggestion.originalLevel})</strong>.</p>
                            <p class="text-xs text-slate-400">${pathwayNamesText}</p>
                        </div>
                    </div>
                `;
                improvementSuggestionsContainer.innerHTML += suggestionCard;
            });
        };


        // --- Event Handlers ---
        function handleAddOrUpdateSubject() {
            const currentSubjectVal = subjectSelect.value;
            const currentLevelVal = levelSelect.value;
            const currentGradeVal = gradeSelect.value;

            if (!currentSubjectVal || !currentLevelVal || !currentGradeVal) {
                showMessage("Please select subject, level, and grade.");
                return;
            }

            // Check for duplicate subject (same subject and level)
            const isDuplicate = studentSubjects.some(s => s.subjectId === currentSubjectVal);
            if (isDuplicate) {
                showMessage("Duplicate Subject", "This subject has already been added. Please edit the existing entry in the table below or choose a different subject.");
                return;
            }
            studentSubjects.push({ subjectId: currentSubjectVal, level: currentLevelVal, grade: currentGradeVal });
            
            // Reset form
            subjectSelect.value = '';
            levelSelect.value = 'G3';
            populateGradeDropdown('G3'); 
            gradeSelect.value = G3_GRADES_OPTIONS[0];

            updateAllCalculationsAndRender();
        }

        window.handleDeleteSubject = (index) => { // Make it global for onclick
            if (confirm("Are you sure you want to delete this subject?")) {
                studentSubjects.splice(index, 1);
                updateAllCalculationsAndRender();
            }
        };
        
        function updateAllCalculationsAndRender() {
            bonusPoints = parseInt(bonusInput.value) || 0;
            if (bonusPoints < 0) bonusPoints = 0;
            if (bonusPoints > 4) bonusPoints = 4;
            bonusInput.value = bonusPoints; // Ensure value is within bounds

            checkEligibility();
            renderStudentSubjectsTable();
            generateImprovementSuggestions(); // Call this to update suggestions
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            currentYearSpan.textContent = new Date().getFullYear();
            populateSubjectDropdown();
            populateLevelDropdown();
            populateGradeDropdown(levelSelect.value); // Populate for default level

            levelSelect.addEventListener('change', (e) => populateGradeDropdown(e.target.value));
            addUpdateSubjectBtn.addEventListener('click', handleAddOrUpdateSubject);
            bonusInput.addEventListener('change', updateAllCalculationsAndRender);
            bonusInput.addEventListener('keyup', (e) => { // For immediate update on number change
                if (e.key >= '0' && e.key <= '9' || e.key === 'Backspace' || e.key === 'Delete') {
                     updateAllCalculationsAndRender();
                }
            });
            
            // Initial render for placeholders
            renderEligibilityResults([]);
            generateImprovementSuggestions(); // Initial call for suggestions section
        });

    </script>
</body>
</html>
